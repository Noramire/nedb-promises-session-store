"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.default=void 0;var _nedbPromises=_interopRequireDefault(require("nedb-promises")),_events=require("events"),_this=void 0;function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}function asyncGeneratorStep(a,b,c,d,e,f,g){try{var h=a[f](g),i=h.value}catch(a){return void c(a)}h.done?b(i):Promise.resolve(i).then(d,e)}function _asyncToGenerator(a){return function(){var b=this,c=arguments;return new Promise(function(d,e){function f(a){asyncGeneratorStep(h,d,e,f,g,"next",a)}function g(a){asyncGeneratorStep(h,d,e,f,g,"throw",a)}var h=a.apply(b,c);f(void 0)})}}function ownKeys(a,b){var c=Object.keys(a);if(Object.getOwnPropertySymbols){var d=Object.getOwnPropertySymbols(a);b&&(d=d.filter(function(b){return Object.getOwnPropertyDescriptor(a,b).enumerable})),c.push.apply(c,d)}return c}function _objectSpread(a){for(var b,c=1;c<arguments.length;c++)b=null==arguments[c]?{}:arguments[c],c%2?ownKeys(Object(b),!0).forEach(function(c){_defineProperty(a,c,b[c])}):Object.getOwnPropertyDescriptors?Object.defineProperties(a,Object.getOwnPropertyDescriptors(b)):ownKeys(Object(b)).forEach(function(c){Object.defineProperty(a,c,Object.getOwnPropertyDescriptor(b,c))});return a}function _defineProperty(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}var ONE_DAY=864e5,TWO_WEEKS=1209600000,makeStore=function(a){var b,c,d=null!==(b=a.defaultExpiry)&&void 0!==b?b:TWO_WEEKS,e=_nedbPromises.default.create(_objectSpread(_objectSpread({},a),{},{autoload:!0,timestampData:!0,onload:function onload(b){b&&g.emit("error",b),g.emit("".concat(b?"dis":"","connect")),a.onload&&a.onload(b)}},a.inMemoryOnly?{afterSerialization:void 0,beforeDeserialization:void 0,corruptAlertThreshold:void 0}:{}));if(a.filename&&a.autoCompactInterval){// autoCompactInterval in the region [5000, ONE_DAY]
var h=Math.min(Math.max(a.autoCompactInterval,5e3),ONE_DAY);e.persistence.setAutocompactionInterval(h)}var f=(null!==(c=a.connect.Store)&&void 0!==c?c:a.connect.session.Store).prototype,g=_objectSpread(_objectSpread(_objectSpread({},_events.EventEmitter.prototype),f),{},{set:function(){var a=_asyncToGenerator(/*#__PURE__*/regeneratorRuntime.mark(function f(a,b,c){var g,h,i;return regeneratorRuntime.wrap(function(f){for(;;)switch(f.prev=f.next){case 0:return h=null!==b&&void 0!==b&&null!==(g=b.cookie)&&void 0!==g&&g.expires?new Date(b.cookie.expires):new Date(Date.now()+d),i=_objectSpread({},b),f.prev=2,f.next=5,e.update({_id:a},{$set:{session:i,expiresAt:h}},{multi:!1,upsert:!0});case 5:c&&c(),f.next=11;break;case 8:f.prev=8,f.t0=f["catch"](2),c&&c(f.t0);case 11:case"end":return f.stop();}},f,null,[[2,8]])}));return function set(){return a.apply(this,arguments)}}(),touch:function(){var a=_asyncToGenerator(/*#__PURE__*/regeneratorRuntime.mark(function d(a,b,c){var f,g;return regeneratorRuntime.wrap(function(d){for(;;)switch(d.prev=d.next){case 0:return g=_objectSpread({updatedAt:new Date},null!==b&&void 0!==b&&null!==(f=b.cookie)&&void 0!==f&&f.expires?{expiresAt:new Date(b.cookie.expires)}:{}),d.next=3,e.update({_id:a},{$set:g},{multi:!1,upsert:!1});case 3:c&&c();case 4:case"end":return d.stop();}},d)}));return function touch(){return a.apply(this,arguments)}}(),get:function(){var a=_asyncToGenerator(/*#__PURE__*/regeneratorRuntime.mark(function c(a,b){var d;return regeneratorRuntime.wrap(function(c){for(;;)switch(c.prev=c.next){case 0:return c.prev=0,c.next=3,e.findOne({_id:a});case 3:if(d=c.sent,null==d){c.next=8;break}if(!(d.session&&!d.expiresAt||new Date<d.expiresAt)){c.next=7;break}return c.abrupt("return",b(null,d.session));case 7:return c.abrupt("return",g.destroy(a,function(a){b(a,null)}));case 8:b(null),c.next=14;break;case 11:c.prev=11,c.t0=c["catch"](0),b(c.t0,null);case 14:case"end":return c.stop();}},c,null,[[0,11]])}));return function get(){return a.apply(this,arguments)}}(),all:function(){var a=_asyncToGenerator(/*#__PURE__*/regeneratorRuntime.mark(function b(a){var c,d;return regeneratorRuntime.wrap(function(b){for(;;)switch(b.prev=b.next){case 0:return b.prev=0,b.next=3,e.find({});case 3:c=b.sent,d=c.reduce(function(a,b){return(b.session&&!b.expiresAt||new Date<b.expiresAt)&&a.push(b.session),g.destroy(b._id,function(a){return a&&g.emit("error",a)}),a},[]),a(null,d),b.next=11;break;case 8:b.prev=8,b.t0=b["catch"](0),a(b.t0,null);case 11:case"end":return b.stop();}},b,null,[[0,8]])}));return function all(){return a.apply(this,arguments)}}(),length:function(){var a=_asyncToGenerator(/*#__PURE__*/regeneratorRuntime.mark(function b(a){return regeneratorRuntime.wrap(function(b){for(;;)switch(b.prev=b.next){case 0:null!=g.all&&g.all(function(b,c){a(b,c.length)});case 1:case"end":return b.stop();}},b)}));return function length(){return a.apply(this,arguments)}}(),destroy:function(){var a=_asyncToGenerator(/*#__PURE__*/regeneratorRuntime.mark(function c(a,b){return regeneratorRuntime.wrap(function(c){for(;;)switch(c.prev=c.next){case 0:return c.prev=0,c.next=3,e.remove({_id:a},{multi:!1});case 3:b&&b(),c.next=9;break;case 6:c.prev=6,c.t0=c["catch"](0),b&&b(c.t0);case 9:case"end":return c.stop();}},c,null,[[0,6]])}));return function destroy(){return a.apply(this,arguments)}}(),clear:function(){var a=_asyncToGenerator(/*#__PURE__*/regeneratorRuntime.mark(function b(a){return regeneratorRuntime.wrap(function(b){for(;;)switch(b.prev=b.next){case 0:return b.prev=0,b.next=3,e.remove({},{multi:_this});case 3:a&&a(),b.next=9;break;case 6:b.prev=6,b.t0=b["catch"](0),a&&a(b.t0);case 9:case"end":return b.stop();}},b,null,[[0,6]])}));return function clear(){return a.apply(this,arguments)}}()});return g},_default=makeStore;exports.default=_default;
